# This workflow will do a clean installation of node dependencies, cache/restore them, and lint the project.
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-nodejs

name: Pull Request Ops

on: 
  pull_request: 
    types: [opened, edited, synchronize, reopened, review_requested]
    
env:
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
jobs:
  auto-assign-and-label:
    name: Assign & Label
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      - name: Add assignee
        run: | # Get the PR number and assign it to the PR author
          PR_NUMBER=${{ github.event.pull_request.number }}
          AUTHOR=${{ github.actor }}
          gh pr edit "$PR_NUMBER" --add-assignee "$AUTHOR"     
          
      - name: Attatch Labels
        uses: srvaroa/labeler@master
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Update PR Status to In Progress
        uses: nipe0324/update-project-v2-item-field@v2.0.2
        with:
          project-url: https://github.com/orgs/pahukama/projects/2
          github-token: ${{ secrets.RW_REPO }}
          field-name: "Status"
          field-value: "Development - In Progress"
      
      - name: Update PR Status To Under Review
        if: ${{ github.event.action == 'review_requested' }}
        uses: nipe0324/update-project-v2-item-field@v2.0.2
        with:
          project-url: https://github.com/orgs/pahukama/projects/2
          github-token: ${{ secrets.RW_REPO }}
          field-name: "Status"
          field-value: "Development - Under Review"

      - name: Get Linked Issue ID
        id: get_issue_id
        run: |
          ISSUE_ID=$(gh pr view ${{ github.event.pull_request.number }} --json closingIssuesReferences --jq '.closingIssuesReferences[0].id')
          echo "LINKED_ISSUE_ID=$ISSUE_ID" >> $GITHUB_ENV

      - name: Update Issue Status to In Development
        id: get_project_details
        if: env.LINKED_ISSUE_ID
        run: |
          gh project list --owner pahukama
          PROJECT_ID=$(gh project view 2 --owner pahukama --format json | jq -r '.id')
          FIELDS=$(gh project field-list 2 --owner pahukama --format json)
          
          STATUS_FIELD_ID=$(echo "$FIELDS" | jq -r '.[] | select(.name == "Status") | .id')
          IN_PROGRESS_OPTION_ID=$(echo "$FIELDS" | jq -r '.[] | select(.name == "Status") | .options[] | select(.name == "Backlog - In Development") | .id')

          gh project item-edit $PROJECT_ID --id ${{ env.LINKED_ISSUE_ID }} --field-id $STATUS_FIELD_ID --single-select-option-id $IN_PROGRESS_OPTION_ID        
          
        
  validate-title:
    name: Validate PR Title
    runs-on: ubuntu-latest

    steps:
      - name: Check PR Title
        uses: deepakputhraya/action-pr-title@master
        with:
          regex: '^(feature|fix|task|refactor|revert){1}(\([\w\-\.]+\))?(!)?: ([\w ])+([\s\S]*)' # Conventional grouping style commit
          allowed_prefixes: 'feature,fix,task,refactor,revert,test' # title should start with the given prefix
          prefix_case_sensitive: false # title prefix are case insensitive
          min_length: 15 # Min length of the title
          max_length: 72 # Max length of the title
          verbal_description: 'PR title must match conventional format, ex. {feature,fix,task,refactor,revert,test}(ISSUE-#): my pull request' # Verbal description of the regex rule
          github_token: ${{ github.token }} # Default: ${{ github.token }}
